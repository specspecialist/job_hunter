<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>JobHunter Admin</title>
  <meta name="google-signin-client_id" content="">
  <style>
    body { font-family: system-ui, Arial; padding: 24px; }
    input, button { padding: 8px; margin: 4px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px }
    th, td { border: 1px solid #ddd; padding: 8px; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>JobHunter â€” Admin (Google Sign-In)</h2>

  <div id="gSignIn">
    <div id="g_id_onload"
         data-client_id=""
         data-login_uri=""
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <div id="controls" style="display:none">
    <label>Hours: <input id="hours" type="number" min="1" value="24"/></label>
    <button id="fetchBtn">Fetch Jobs</button>
    <button id="downloadCsvBtn">Download CSV</button>
    <button id="exportSheetsBtn">Export to Google Sheets</button>
    <div id="status"></div>
    <div id="jobsCount"></div>
    <table id="jobsTable"></table>
  </div>

  <script>
    let token = null;

    function handleCredentialResponse(response) {
      fetch('/.netlify/functions/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id_token: response.credential })
      }).then(res => res.json()).then(j => {
        if (j.token) {
          token = j.token;
          document.getElementById('gSignIn').style.display = 'none';
          document.getElementById('controls').style.display = 'block';
        } else {
          alert('Login failed: ' + (j.error || 'unknown'));
        }
      }).catch(e => { alert('Login error'); console.error(e); });
    }

    window.handleCredentialResponse = handleCredentialResponse;

    async function fetchJobs() {
      const h = document.getElementById('hours').value || 24;
      document.getElementById('status').textContent = 'Fetching...';
      const res = await fetch(`/.netlify/functions/jobs?hours=${h}`);
      const j = await res.json();
      document.getElementById('status').textContent = 'Done';
      document.getElementById('jobsCount').textContent = `${j.count} jobs`;
      const tbl = document.getElementById('jobsTable');
      tbl.innerHTML = '';
      const header = ['Title','Company','Location','URL','Posted At','Source'];
      const thead = document.createElement('tr');
      header.forEach(hh => { const th = document.createElement('th'); th.textContent = hh; thead.appendChild(th); });
      tbl.appendChild(thead);
      (j.jobs || []).forEach(job => {
        const tr = document.createElement('tr');
        [job.title, job.company, job.location, job.url, job.posted_at, job.source].forEach(v => {
          const td = document.createElement('td');
          if (v && v.startsWith && v.startsWith('http')) {
            const a = document.createElement('a'); a.href = v; a.textContent = v; a.target = '_blank'; td.appendChild(a);
          } else td.textContent = v || '';
          tr.appendChild(td);
        });
        tbl.appendChild(tr);
      });
      window._lastJobs = j.jobs || [];
    }

    document.getElementById('fetchBtn').addEventListener('click', fetchJobs);

    document.getElementById('downloadCsvBtn').addEventListener('click', async () => {
      if (!token) return alert('Login first');
      const h = document.getElementById('hours').value || 24;
      const res = await fetch(`/.netlify/functions/export_csv?hours=${h}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) return alert('Export failed');
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `jobs-${h}h.csv`; document.body.appendChild(a); a.click(); a.remove();
    });

    document.getElementById('exportSheetsBtn').addEventListener('click', async () => {
      if (!token) return alert('Login first');
      const h = document.getElementById('hours').value || 24;
      document.getElementById('status').textContent = 'Exporting to Sheets...';
      const res = await fetch(`/.netlify/functions/export_sheets?hours=${h}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const j = await res.json();
      document.getElementById('status').textContent = j.success ? `Exported ${j.written} rows` : `Error: ${j.error || 'unknown'}`;
    });
  </script>
</body>
</html>
